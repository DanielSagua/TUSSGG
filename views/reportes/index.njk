{% extends "layouts/main.njk" %}

{% block content %}
  <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-3">
    <div>
      <h1 class="h4 mb-0">Reportes</h1>
      <div class="text-muted small">KPIs y breakdowns según filtros.</div>
    </div>

    <div class="d-flex gap-2">
      <a id="btn-export-csv" class="btn btn-outline-secondary btn-sm" href="#">Exportar CSV</a>
      <a id="btn-export-xlsx" class="btn btn-outline-secondary btn-sm" href="#">Exportar Excel</a>
    </div>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <form id="form-filtros" class="row g-2 align-items-end">
        <div class="col-6 col-md-2">
          <label class="form-label">Desde</label>
          <input class="form-control" type="date" name="from" id="f-from">
        </div>

        <div class="col-6 col-md-2">
          <label class="form-label">Hasta</label>
          <input class="form-control" type="date" name="to" id="f-to">
        </div>

        <div class="col-12 col-md-2">
          <label class="form-label">Estado</label>
          <select class="form-select" name="estado" id="f-estado">
            <option value="">Todos</option>
            {% for e in estados %}
              <option value="{{ e.id }}">{{ e.nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-2">
          <label class="form-label">Tipo</label>
          <select class="form-select" name="tipo" id="f-tipo">
            <option value="">Todos</option>
            {% for t in tipos %}
              <option value="{{ t.id }}">{{ t.nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-2">
          <label class="form-label">Ubicación</label>
          <select class="form-select" name="ubicacion" id="f-ubicacion">
            <option value="">Todas</option>
            {% for u in ubicaciones %}
              <option value="{{ u.id }}">{{ u.nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-2">
          <label class="form-label">Prioridad</label>
          <select class="form-select" name="prioridad" id="f-prioridad">
            <option value="">Todas</option>
            {% for p in prioridades %}
              <option value="{{ p.id }}">{{ p.nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Búsqueda</label>
          <input class="form-control" type="text" name="search" id="f-search" placeholder="Descripción / proveedor / OC / solicitado por...">
        </div>

        <div class="col-12 col-md-2">
          <button id="btn-actualizar" class="btn btn-primary w-100" type="submit">
            <span class="spinner-border spinner-border-sm me-2 d-none" id="sp-loading" aria-hidden="true"></span>
            Actualizar
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-12 col-md-2">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Total</div>
          <div class="h4 mb-0" id="kpi-total">—</div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-2">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Abiertos</div>
          <div class="h4 mb-0" id="kpi-abiertos">—</div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-2">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Cerrados (rango)</div>
          <div class="h4 mb-0" id="kpi-cerrados">—</div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-2">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Atrasados (SLA)</div>
          <div class="h4 mb-0" id="kpi-atrasados">—</div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-2">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Prom. días cierre</div>
          <div class="h4 mb-0" id="kpi-avg-cierre">—</div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-2">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Mediana días cierre</div>
          <div class="h4 mb-0" id="kpi-mediana-cierre">—</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h6 mb-3">Por estado</h2>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>Estado</th>
                  <th class="text-end">Total</th>
                </tr>
              </thead>
              <tbody id="tbl-estado">
                <tr><td colspan="2" class="text-muted">—</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h6 mb-3">Por tipo</h2>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>Tipo</th>
                  <th class="text-end">Total</th>
                </tr>
              </thead>
              <tbody id="tbl-tipo">
                <tr><td colspan="2" class="text-muted">—</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h6 mb-3">Por ubicación</h2>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>Ubicación</th>
                  <th class="text-end">Total</th>
                </tr>
              </thead>
              <tbody id="tbl-ubicacion">
                <tr><td colspan="2" class="text-muted">—</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h6 mb-3">Por prioridad</h2>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>Prioridad</th>
                  <th class="text-end">Total</th>
                </tr>
              </thead>
              <tbody id="tbl-prioridad">
                <tr><td colspan="2" class="text-muted">—</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h6 mb-3">Top proveedores (por monto)</h2>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>Proveedor</th>
                  <th class="text-end">Trabajos</th>
                  <th class="text-end">Monto Neto</th>
                </tr>
              </thead>
              <tbody id="tbl-proveedores">
                <tr><td colspan="3" class="text-muted">—</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="/js/reportes.js"></script>
{% endblock %}
